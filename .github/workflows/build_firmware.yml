name: Build Firmware

on: [push, pull_request]

jobs:
  build-firmware:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo and submodules
      uses: actions/checkout@v3
      with:
        submodules: recursive
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt-get install arduino-mk
    - name: Build
      run: |
        ./build.sh
        ls build
    - name: Cache build asset
      uses: actions/cache/save@v3
      with:
        path: build/*.hex
        key: build-${{ hashFiles('build/*.hex') }}
    - name: Archive Build
      uses: actions/upload-artifact@v3
      with:
        name: ${{format('{0}-{1}',github.sha,github.run_number)}}
        path: build/*.hex

  release-firmware:
    if:  ${{ (github.event_name == 'push') && (github.ref_type == 'tag') && (startsWith(github.ref_name, 'v') || startsWith(github.ref_name, 'test')) }}
    needs: build-firmware
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo and submodules
      uses: actions/checkout@v3
      with:
        submodules: recursive
    - name: Set variables
      id: vars
      run: |
        echo "sha-short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "tag=$(git describe --tags)" >> $GITHUB_OUTPUT
        echo "draft=$(git describe --tags | sed -e 's/^test.*/true/;s/^v.*/false/')" >> $GITHUB_OUTPUT
    - name: Restore cached asset
      id:   restore-cache
      uses: actions/cache@v3
      with:
        path: build/*.hex
        key:  build-${{ hashFiles('build/*.hex') }}
        fail-on-cache-miss: true
    - name: Create release
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ steps.vars.outputs.tag }}
        name: Release ${{ steps.vars.outputs.tag }}
        commit: ${{ steps.vars.outputs.sha }}
        body: ""  # release message, alternative to body_path
        # body_path: release_text.md  # uncomment if not used
        draft: ${{ steps.vars.outputs.draft }}
        prerelease: false
        allowUpdates: true
        artifacts: build/*.hex
        replacesArtifacts: true
        
  deploy:
    name: Create and deploy source code documentation
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
    - name: Install dependencies for doxygen
      run: |
        sudo apt-get install doxygen graphviz -y
    - name: Create .nojekyll so that filenames with underscores work on Github Pages
      run: |
        mkdir -p docs/html
        touch docs/html/.nojekyll
    - name: Deploy to pages
      uses: DenverCoder1/doxygen-github-pages-action@v1.3.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: gh-pages
        folder: doc
        config_file: Doxyfile
